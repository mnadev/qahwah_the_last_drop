<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Qahwah: The Last Drop</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Lato:wght@400;900&display=swap');

    body {
      margin: 0;
      overflow: hidden;
      background-color: #050505;
      font-family: 'Helvetica Neue', 'Helvetica', 'Arial', sans-serif;
      touch-action: none;
      user-select: none;
      -webkit-user-select: none;
    }

    #game-container {
      position: relative;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
    }

    canvas {
      display: block;
      width: 100%;
      height: 100%;
    }

    /* UI Layer */
    #ui-layer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    /* Coffee Meter */
    #meter-container {
      margin-top: 20px;
      width: 300px;
      height: 30px;
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid #FFD700;
      border-radius: 0px;
      /* Sharp edges for fashion look */
      position: relative;
      overflow: hidden;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
    }

    #meter-fill {
      width: 100%;
      height: 100%;
      background: #FFD700;
      transform-origin: left;
      transition: width 0.1s linear;
    }

    #meter-label {
      position: absolute;
      width: 100%;
      text-align: center;
      top: 4px;
      font-size: 0.9rem;
      color: #fff;
      text-shadow: 1px 1px 2px #000;
      font-weight: bold;
      letter-spacing: 1px;
    }

    #score-display {
      font-family: 'Bernhardt Fashion BT', 'Didot', 'Bodoni MT', 'Cinzel', serif;
      font-size: 2rem;
      color: #FFD700;
      text-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
      margin-top: 10px;
      letter-spacing: 2px;
    }

    /* Screens */
    .screen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(5, 5, 5, 0.95);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      pointer-events: auto;
      z-index: 100;
      transition: opacity 0.2s;
      text-align: center;
      padding: 20px;
      box-sizing: border-box;
    }

    .hidden {
      opacity: 0;
      pointer-events: none;
    }

    h1 {
      font-family: 'Bernhardt Fashion BT', 'Didot', 'Bodoni MT', 'Cinzel', serif;
      color: #FFD700;
      font-size: 3rem;
      margin: 0 0 10px 0;
      text-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
      font-weight: normal;
      letter-spacing: 3px;
      text-transform: uppercase;
    }

    p {
      color: #FFFFFF;
      font-size: 1.1rem;
      max-width: 600px;
      line-height: 1.6;
      font-weight: 300;
    }

    button {
      background: #000;
      border: 1px solid #FFD700;
      color: #FFD700;
      padding: 15px 40px;
      font-size: 1.2rem;
      font-family: 'Bernhardt Fashion BT', 'Didot', 'Bodoni MT', 'Cinzel', serif;
      margin-top: 30px;
      cursor: pointer;
      border-radius: 0;
      box-shadow: 0 5px 15px rgba(255, 215, 0, 0.1);
      transition: all 0.2s;
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    button:hover {
      background: #FFD700;
      color: #000;
    }

    button:active {
      transform: scale(0.95);
    }

    .secondary-btn {
      background: transparent;
      border: 1px solid #666;
      color: #888;
      margin-top: 15px;
      font-size: 0.9rem;
      padding: 10px 30px;
      font-family: 'Helvetica Neue', 'Helvetica', 'Arial', sans-serif;
      letter-spacing: 1px;
    }

    .secondary-btn:hover {
      border-color: #FFD700;
      color: #FFD700;
      background: transparent;
    }

    .tutorial-icon {
      font-size: 3rem;
      margin: 15px;
    }

    .warn-text {
      color: #FF5252;
      font-weight: bold;
    }
  </style>
</head>

<body>

  <div id="game-container">
    <canvas id="gameCanvas"></canvas>

    <div id="ui-layer">
      <div id="meter-container">
        <div id="meter-fill"></div>
        <div id="meter-label">QAHWAH LEVEL</div>
      </div>
      <div id="score-display">0.00s</div>
    </div>

    <!-- Start Screen -->
    <div id="start-screen" class="screen">
      <h1>QAHWAH: THE LAST DROP</h1>
      <p>Every drop of this coffee is precious.</p>
      <p>Keep the Dallah in the <span style="color:#FFD700">GOLD SAFE ZONE</span>.</p>
      <p>If it slides out, the Qahwah spills!</p>
      <div class="tutorial-icon">‚öñÔ∏è</div>
      <p style="font-size: 0.9rem; color: #888;">Mouse / Drag / Tilt to Balance</p>
      <button onclick="Game.start()">Protect the Pour</button>
    </div>

    <!-- Game Over Screen -->
    <div id="game-over-screen" class="screen hidden">
      <h1 style="color:#FFF">NOT A DROP LEFT</h1>
      <p>You saved the Qahwah for:</p>
      <h2 id="final-time" style="font-size: 3.5rem; color: #fff; margin: 10px 0;">0.00</h2>
      <p>seconds</p>
      <button onclick="Game.start()">Brew Again</button>
      <button class="secondary-btn" onclick="Game.share()">Share Score</button>
    </div>
  </div>

  <script>
    const Game = {
      canvas: document.getElementById('gameCanvas'),
      ctx: document.getElementById('gameCanvas').getContext('2d'),
      width: 0,
      height: 0,
      dpr: 1, // Device Pixel Ratio
      animationId: null,
      state: 'START',

      // Game Stats
      startTime: 0,
      elapsedTime: 0,
      coffeeLevel: 100, // 0 to 100

      // Physics
      trayAngle: 0,
      inputAngle: 0,
      intensity: 0,

      // Objects
      pot: { x: 0, velocity: 0, width: 60, height: 90 },
      particles: [], // For spill effect
      drops: [], // Falling items
      highScore: 0,

      // Input State
      isTouching: false,

      // Fun Facts
      funFacts: [
        "Yemen is the world's first cultivator of coffee, dating back to the 15th century.",
        "The word 'Mocha' comes from the Yemeni port city of Al-Makha.",
        "Yemeni coffee is naturally organic and grown on ancient mountain terraces.",
        "Yemeni coffee is known for its complex notes of chocolate, dried fruit, and spices.",
        "Qishr is a traditional drink made from coffee husks, often spiced with ginger and cardamom.",
        "Jubani coffee comes from the Juban district and is known for its mild, fruity flavor.",
        "Sana'ani coffee refers to the classic blend popular in the capital, Sana'a.",
        "Maleki (Royal) coffee is a premium grade, traditionally reserved for special guests.",
        "Adeni Chai is a rich, spiced tea with milk, similar to Karak Chai, reflecting Yemen's trade history with India.",
        "While coffee was discovered in Ethiopia, it was first cultivated and traded globally from Yemen.",
        "The world's first coffee houses, or 'kaveh kanes', appeared in Yemen in the 15th century.",
        "Sufi monks in Yemen were the first to brew coffee to stay awake for prayers.",
        "Old Sana'a is famous for its unique gingerbread-style tower houses, considered the world's first skyscrapers."
      ],
      currentFunFact: "",

      init: function () {
        // Handle High DPI
        this.dpr = window.devicePixelRatio || 1;
        this.resize();
        window.addEventListener('resize', () => this.resize());

        // Load High Score
        const savedScore = localStorage.getItem('qahwah_highscore');
        if (savedScore) {
          this.highScore = parseFloat(savedScore);
        }
        this.updateHighScoreDisplay();

        // Mouse Input
        window.addEventListener('mousemove', e => this.handleInput(e.clientX));

        // Touch Input
        window.addEventListener('touchstart', () => { this.isTouching = true; }, { passive: false });
        window.addEventListener('touchend', () => { this.isTouching = false; }, { passive: false });
        window.addEventListener('touchcancel', () => { this.isTouching = false; }, { passive: false });

        window.addEventListener('touchmove', e => {
          e.preventDefault();
          this.isTouching = true;
          this.handleInput(e.touches[0].clientX);
        }, { passive: false });

        // Gyro (Optional)
        window.addEventListener('deviceorientation', e => {
          // Only use gyro if not currently touching the screen
          if (e.gamma && this.state === 'PLAYING' && !this.isTouching) {
            let tilt = Math.max(-45, Math.min(45, e.gamma));
            this.inputAngle = tilt * (Math.PI / 180);
          }
        });

        // Start the render loop immediately (for background)
        this.loop();
      },

      resize: function () {
        this.width = window.innerWidth;
        this.height = window.innerHeight;

        // Fix blurriness on Retina screens
        this.canvas.width = this.width * this.dpr;
        this.canvas.height = this.height * this.dpr;
        this.ctx.scale(this.dpr, this.dpr);
      },

      handleInput: function (clientX) {
        if (this.state !== 'PLAYING') return;

        const center = this.width / 2;
        // Determine screen side (-1 left, 1 right)
        const percent = (clientX - center) / (this.width / 2);

        // Control Scheme: Direct Tilt
        // Max tilt = 35 degrees
        this.inputAngle = percent * (35 * Math.PI / 180);
      },

      start: function () {
        this.state = 'PLAYING';
        this.startTime = Date.now();
        this.coffeeLevel = 100;
        this.particles = [];
        this.drops = [];
        this.pot.x = 0;
        this.pot.velocity = 0;
        this.inputAngle = 0;
        this.intensity = 0;
        this.isTouching = false;

        // UI Reset
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('game-over-screen').classList.add('hidden');
        document.getElementById('meter-fill').style.width = '100%';
        document.getElementById('score-display').innerText = "0.00s";

        // Remove dynamic elements
        const fact = document.getElementById('fun-fact-display');
        if (fact) fact.remove();
        const link = document.getElementById('haraz-link');
        if (link) link.remove();
      },

      gameOver: function () {
        this.state = 'GAMEOVER';
        const gameOverScreen = document.getElementById('game-over-screen');
        gameOverScreen.classList.remove('hidden');
        document.getElementById('final-time').innerText = this.elapsedTime;

        // Check High Score
        if (parseFloat(this.elapsedTime) > this.highScore) {
          this.highScore = parseFloat(this.elapsedTime);
          localStorage.setItem('qahwah_highscore', this.highScore);
        }
        this.updateHighScoreDisplay();

        // Select and display random fun fact
        this.currentFunFact = this.funFacts[Math.floor(Math.random() * this.funFacts.length)];

        // Create fun fact element
        let factElement = document.createElement('p');
        factElement.id = 'fun-fact-display';
        factElement.style.color = '#FFD700';
        factElement.style.fontStyle = 'italic';
        factElement.style.marginTop = '20px';
        factElement.innerText = "Did you know? " + this.currentFunFact;

        // Create Link Element
        let linkElement = document.createElement('a');
        linkElement.id = 'haraz-link';
        linkElement.href = 'https://www.harazcoffeehouse.com';
        linkElement.target = '_blank';
        linkElement.style.color = '#E65100';
        linkElement.style.display = 'block';
        linkElement.style.marginTop = '15px';
        linkElement.style.textDecoration = 'underline';
        linkElement.style.fontWeight = 'bold';
        linkElement.innerText = "Visit Haraz Coffee House";

        // Insert before the buttons
        const firstButton = gameOverScreen.getElementsByTagName('button')[0];
        gameOverScreen.insertBefore(factElement, firstButton);
        gameOverScreen.insertBefore(linkElement, firstButton);
      },

      loop: function () {
        requestAnimationFrame(() => this.loop());

        // Always draw background
        this.draw();

        if (this.state === 'PLAYING') {
          this.update();
        }
      },

      update: function () {
        const now = Date.now();
        const dt = 0.016; // Fixed step

        // 1. Time & Difficulty
        this.elapsedTime = ((now - this.startTime) / 1000).toFixed(2);
        document.getElementById('score-display').innerText = this.elapsedTime + "s";

        // Intensity ramps up over 60 seconds
        // Non-linear ramp: starts slow, gets crazy
        const timeFactor = (now - this.startTime) / 60000;
        this.intensity = Math.min(1.0, Math.pow(timeFactor, 1.5)); // x^1.5 for slower start

        // 2. Physics (Smoothed out)
        const t = now / 1000;
        // Reduced noise for smoother feel
        const shake = Math.sin(t * 3) * 0.3;
        // Removed the random "jolt" as it felt like a bug/jitter

        const groundTilt = shake * (0.05 + this.intensity * 0.2);

        // 3. Tray Physics
        // Smoother lerp for weight feel
        const targetAngle = this.inputAngle + groundTilt;
        this.trayAngle += (targetAngle - this.trayAngle) * 0.05; // Reduced from 0.1 for more weight/smoothness

        // 4. Pot Physics
        // Gravity pulling pot down slope
        const gravity = 4000;
        const slideForce = Math.sin(this.trayAngle) * gravity;

        this.pot.velocity += slideForce * dt;

        // Sliding Friction
        this.pot.velocity *= 0.95;

        this.pot.x += this.pot.velocity * dt;

        // 5. Spilling Logic (The new mechanic)
        const safeZoneRadius = 60; // Pixels from center
        const spillThreshold = 10; // Extra buffer

        if (Math.abs(this.pot.x) > safeZoneRadius + spillThreshold) {
          // We are outside safe zone!
          // Calculate how far out
          const overflow = Math.abs(this.pot.x) - safeZoneRadius;
          const drainRate = 0.1 + (overflow * 0.005); // Faster drain if further out

          this.coffeeLevel -= drainRate;
          if (this.coffeeLevel < 0) this.coffeeLevel = 0;

          // Spawn Particles
          if (Math.random() > 0.5) {
            this.spawnParticle(this.pot.x, -40);
          }
        }

        // UI Update
        document.getElementById('meter-fill').style.width = this.coffeeLevel + '%';
        if (this.coffeeLevel < 30) {
          document.getElementById('meter-fill').style.backgroundColor = '#FF0000'; // Stark Red
        } else {
          document.getElementById('meter-fill').style.backgroundColor = '#FFD700'; // Gold
        }

        // Check Game Over
        if (this.coffeeLevel <= 0) {
          this.gameOver();
        }

        // Bounds Check (Hard limit)
        const limit = (this.width * 0.8 / 2) - 30;
        if (Math.abs(this.pot.x) > limit) {
          this.pot.velocity = -this.pot.velocity * 0.5; // Bounce
          this.pot.x = Math.sign(this.pot.x) * limit;
          // Massive spill on impact
          this.coffeeLevel -= 5;
          for (let i = 0; i < 10; i++) this.spawnParticle(this.pot.x, -40);
        }

        // Update Particles
        for (let i = this.particles.length - 1; i >= 0; i--) {
          let p = this.particles[i];
          p.x += p.vx;
          p.y += p.vy;
          p.vy += 0.5; // Gravity
          p.life--;
          if (p.life <= 0) this.particles.splice(i, 1);
        }

        // 6. Drops Logic
        // Spawn drops based on intensity
        // Base chance 0.5% per frame, increases to 2% at max intensity
        if (Math.random() < 0.005 + (this.intensity * 0.015)) {
          this.spawnDrop();
        }

        for (let i = this.drops.length - 1; i >= 0; i--) {
          let d = this.drops[i];
          d.y += d.speed * (1 + this.intensity); // Drops fall faster with intensity
          d.rotation += d.rotSpeed;

          // Collision with Pot
          // Simple box/circle check
          // Pot is at this.pot.x, y is roughly -35 (bulb center) relative to tray center
          // But drops are in screen coordinates? No, let's keep drops in "Tray Space" or "Screen Space"?
          // Let's use Screen Space for drops to make them fall straight down regardless of tray tilt?
          // Actually, "falling from sky" implies screen space.
          // But the pot is moving in tray space. We need to convert.

          // Let's keep it simple: Drops are in Screen Space (relative to center).
          // Pot X in screen space is roughly: pot.x * cos(trayAngle)
          // Pot Y in screen space is roughly: pot.x * sin(trayAngle) + tray_offset_y

          // Actually, let's just do simple distance check assuming small angles
          // Pot Screen X ~= this.pot.x
          // Pot Screen Y ~= 100 (tray offset) - 35 (pot center) = 65

          const potScreenX = this.pot.x; // Simplified
          const potScreenY = 65;

          const dx = d.x - potScreenX;
          const dy = d.y - potScreenY;
          const dist = Math.sqrt(dx * dx + dy * dy);

          if (dist < 50) { // Hit!
            if (d.type === 'GOOD') {
              this.coffeeLevel = Math.min(100, this.coffeeLevel + 15);
              // Visual feedback
              for (let k = 0; k < 5; k++) this.spawnParticle(this.pot.x, -40);
            } else {
              this.coffeeLevel = Math.max(0, this.coffeeLevel - 20);
              // Visual feedback (Red particles)
              // We'll just use the existing particle system but maybe add color support later
              // For now, just spill effect
              for (let k = 0; k < 5; k++) this.spawnParticle(this.pot.x, -40);
            }
            this.drops.splice(i, 1);
            continue;
          }

          // Remove if off screen
          if (d.y > this.height / 2 + 200) {
            this.drops.splice(i, 1);
          }
        }
      },

      spawnParticle: function (x, y) {
        this.particles.push({
          x: x + (Math.random() - 0.5) * 40,
          y: y,
          vx: this.pot.velocity * 0.01 + (Math.random() - 0.5) * 5,
          vy: -Math.random() * 5 - 2,
          life: 40,
          size: Math.random() * 4 + 2
        });
      },

      spawnDrop: function () {
        // x range: -width/2 to width/2
        const x = (Math.random() - 0.5) * (this.width * 0.8);
        const type = Math.random() > 0.7 ? 'BAD' : 'GOOD'; // 30% bad drops
        this.drops.push({
          x: x,
          y: -this.height / 2 - 50, // Start above screen
          speed: Math.random() * 2 + 3,
          type: type,
          rotation: Math.random() * Math.PI,
          rotSpeed: (Math.random() - 0.5) * 0.1
        });
      },

      updateHighScoreDisplay: function () {
        // Update Start Screen
        let startScore = document.getElementById('start-high-score');
        if (!startScore) {
          startScore = document.createElement('p');
          startScore.id = 'start-high-score';
          startScore.style.color = '#FFD700';
          startScore.style.fontWeight = 'bold';
          const btn = document.querySelector('#start-screen button');
          if (btn) btn.parentNode.insertBefore(startScore, btn);
        }
        startScore.innerText = `Best: ${this.highScore.toFixed(2)}s`;

        // Update Game Over Screen
        let endScore = document.getElementById('end-high-score');
        if (!endScore) {
          endScore = document.createElement('p');
          endScore.id = 'end-high-score';
          endScore.style.color = '#FFD700';
          const btn = document.querySelector('#game-over-screen button');
          if (btn) btn.parentNode.insertBefore(endScore, btn);
        }
        endScore.innerText = `Best: ${this.highScore.toFixed(2)}s`;
      },

      draw: function () {
        const w = this.width;
        const h = this.height;
        const ctx = this.ctx;

        ctx.clearRect(0, 0, w, h);

        // --- Background ---
        ctx.save();
        ctx.translate(w / 2, h / 2);
        // Rotate background slightly opposite to tray for dizziness effect
        ctx.rotate(-this.trayAngle * 0.2);

        // Sky
        const grad = ctx.createLinearGradient(0, -h, 0, h);
        grad.addColorStop(0, '#F5F5F5'); // White/Grey
        grad.addColorStop(1, '#BDBDBD');
        ctx.fillStyle = grad;
        ctx.fillRect(-w, -h, w * 2, h * 2);

        // Stars (Hidden in day/white theme, or maybe black specks?)
        // Let's remove stars for the clean look

        // Sana'a Skyline (Skyscrapers)
        ctx.fillStyle = '#212121'; // Dark Grey for buildings
        ctx.beginPath();

        // Simple blocky skyline
        const groundY = h * 0.2;
        ctx.moveTo(-w, h); // Bottom Left
        ctx.lineTo(-w, groundY); // Start of skyline

        // Draw random-looking buildings (deterministic based on loop)
        const buildingWidth = 40;
        const numBuildings = (w * 2) / buildingWidth;

        for (let i = 0; i < numBuildings; i++) {
          const x = -w + i * buildingWidth;
          // Pseudo-random height based on index
          const height = 50 + Math.abs(Math.sin(i * 132.1)) * 150;
          ctx.lineTo(x, groundY - height);
          ctx.lineTo(x + buildingWidth, groundY - height);
          // Add little "windows" or decoration? Maybe too detailed for now.
        }

        ctx.lineTo(w, groundY);
        ctx.lineTo(w, h); // Bottom Right
        ctx.fill();

        // Add white windows for detail
        ctx.fillStyle = '#FFFFFF';
        for (let i = 0; i < numBuildings; i++) {
          if (i % 2 === 0) continue; // Skip some
          const x = -w + i * buildingWidth;
          const height = 50 + Math.abs(Math.sin(i * 132.1)) * 150;
          // Draw a few windows
          for (let j = 0; j < 3; j++) {
            ctx.fillRect(x + 10, groundY - height + 20 + (j * 30), 5, 10);
            ctx.fillRect(x + 25, groundY - height + 20 + (j * 30), 5, 10);
          }
        }

        ctx.restore();

        // --- Drops (Screen Space) ---
        // We draw them before the tray so they look like they are in the background/midground
        // or after? Let's draw them after background but before tray.
        ctx.save();
        ctx.translate(w / 2, h / 2); // Center origin

        for (let d of this.drops) {
          ctx.save();
          ctx.translate(d.x, d.y);
          ctx.rotate(d.rotation);

          if (d.type === 'GOOD') {
            // Draw Coffee Bean (Brown)
            ctx.fillStyle = '#6D4C41';
            ctx.beginPath();
            ctx.ellipse(0, 0, 10, 15, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.strokeStyle = '#3E2723'; // Darker Brown
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(0, -12);
            ctx.quadraticCurveTo(5, 0, 0, 12);
            ctx.stroke();
          } else {
            // Draw Bad Drop (Black Rock)
            ctx.fillStyle = '#000000';
            ctx.beginPath();
            ctx.moveTo(-10, -10);
            ctx.lineTo(5, -15);
            ctx.lineTo(12, 0);
            ctx.lineTo(0, 12);
            ctx.lineTo(-12, 5);
            ctx.closePath();
            ctx.fill();
          }
          ctx.restore();
        }
        ctx.restore();

        // --- The Tray ---
        ctx.save();
        ctx.translate(w / 2, h / 2 + 100);
        ctx.rotate(this.trayAngle);

        const trayW = Math.min(600, w * 0.85);
        const safeW = 120; // Width of safe zone

        // Tray Body (Black with Gold Border)
        ctx.fillStyle = '#000000';
        ctx.fillRect(-trayW / 2, -5, trayW, 15);
        ctx.strokeStyle = '#FFD700';
        ctx.lineWidth = 2;
        ctx.strokeRect(-trayW / 2, -5, trayW, 15);

        // Safe Zone Marker (Center)
        // If sliding out, turn red, else gold
        const isSafe = Math.abs(this.pot.x) <= 70; // 60 + buffer
        ctx.fillStyle = isSafe ? 'rgba(255, 215, 0, 0.5)' : 'rgba(255, 0, 0, 0.5)';
        ctx.fillRect(-safeW / 2, -15, safeW, 25);

        ctx.strokeStyle = isSafe ? '#FFD700' : '#FF0000';
        ctx.lineWidth = 2;
        ctx.strokeRect(-safeW / 2, -15, safeW, 25);

        // --- The Pot ---
        ctx.translate(this.pot.x, -5);

        // Draw Particles (Behind pot)
        ctx.fillStyle = '#000000'; // Liquid color (Black Coffee)
        for (let p of this.particles) {
          ctx.beginPath();
          ctx.arc(p.x - this.pot.x, p.y, p.size, 0, Math.PI * 2);
          ctx.fill();
        }

        // Pot Style
        const potColor = '#FFD700'; // Gold

        // Pot Fluid Level (Visual)
        // We mask the fluid inside the pot shape
        ctx.save();

        // Define Pot Shape for Clipping
        ctx.beginPath();
        ctx.arc(0, -35, 35, 0, Math.PI * 2); // Bulb
        ctx.rect(-15, -90, 30, 60); // Neck

        ctx.clip(); // Restrict drawing to inside pot

        // Pot Background (Inside)
        ctx.fillStyle = '#FDD835'; // Lighter Gold
        ctx.fill();

        // Coffee Liquid
        const liquidH = 100 * (this.coffeeLevel / 100); // 0 to 100
        const liquidY = -90 + (100 - liquidH); // Top down

        ctx.fillStyle = '#000000'; // Black Coffee

        // Sloshing Liquid Angle (opposes acceleration/tilt)
        ctx.rotate(-this.trayAngle * 1.5);
        ctx.fillRect(-50, liquidY, 100, 150);

        ctx.restore(); // End clipping

        // Draw Pot Outline (Over liquid)
        ctx.strokeStyle = '#000000'; // Black Outline
        ctx.lineWidth = 4;
        ctx.beginPath();
        ctx.arc(0, -35, 35, 0, Math.PI * 2);
        ctx.stroke();
        ctx.strokeRect(-15, -90, 30, 60);

        // Spout
        ctx.fillStyle = potColor;
        ctx.beginPath();
        ctx.moveTo(15, -50);
        ctx.quadraticCurveTo(50, -60, 40, -80);
        ctx.lineTo(30, -70);
        ctx.fill();
        ctx.stroke(); // Add outline to spout

        // Lid
        ctx.beginPath();
        ctx.moveTo(-18, -90);
        ctx.lineTo(0, -115);
        ctx.lineTo(18, -90);
        ctx.fill();
        ctx.stroke(); // Add outline to lid

        ctx.restore();
      },

      share: function () {
        const text = `I saved the Qahwah for ${this.elapsedTime} seconds! ‚òïüáæüá™\n\nDid you know? ${this.currentFunFact}\n\nFind Yemeni coffee at https://www.harazcoffeehouse.com`;
        if (navigator.share) {
          navigator.share({ title: 'Qahwah: The Last Drop', text: text, url: window.location.href });
        } else {
          navigator.clipboard.writeText(text);
          alert("Score and fun fact copied to clipboard!");
        }
      }
    };

    // Start engines
    window.onload = function () {
      Game.init();
    };

  </script>
</body>

</html>